<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>K5Viewer Web</title>
<style>
        :root {
            --bg: #fafbfc;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text: #111827;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --error: #ef4444;
            --radius: 8px;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --accent: #3b82f6;
            --accent-hover: #60a5fa;
            --success: #10b981;
            --error: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            overflow: hidden;
            height: 100vh;
        }
        
        .app {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .brand h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }
        
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background: var(--bg);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        
        .status-pill.connected {
            background: #ecfdf5;
            color: #059669;
            border-color: #a7f3d0;
        }
        
        [data-theme="dark"] .status-pill.connected {
            background: rgba(16, 185, 129, 0.1);
            color: #34d399;
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .btn.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .btn.primary:hover:not(:disabled) {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        
        .btn.danger {
            color: var(--error);
            border-color: var(--error);
        }
        
        .btn.danger:hover:not(:disabled) {
            background: var(--error);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        select {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Main Content */
        .main {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            position: relative;
        }
        
        .display-container {
            position: relative;
        }
        
        #display {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: #000;
            image-rendering: pixelated;
            box-shadow: var(--shadow-lg);
        }
        
        /* Notifications */
        .notifications {
            position: fixed;
            top: 80px;
            right: 24px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .notification {
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 13px;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success {
            border-left: 3px solid var(--success);
            color: var(--success);
        }
        
        .notification.error {
            border-left: 3px solid var(--error);
            color: var(--error);
        }
        
        .notification.info {
            border-left: 3px solid var(--accent);
            color: var(--accent);
        }
        
        @keyframes slideOut {
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--surface);
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            padding: 24px 24px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
        }
        
        .modal-close:hover {
            color: var(--text);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .section {
            margin-bottom: 24px;
        }
        
        .section:last-child {
            margin-bottom: 0;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .shortcuts {
            display: grid;
            gap: 8px;
        }
        
        .shortcut {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }
        
        .shortcut-key {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
            background: var(--bg);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        
        .shortcut-desc {
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
                padding: 16px;
            }
            
            .controls {
                width: 100%;
                justify-content: center;
            }
            
            .main {
                padding: 20px;
            }
            
            .notifications {
                right: 16px;
                top: 120px;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="brand">
                <h1>K5Viewer</h1>
                <div class="status-pill" id="status">
                    <div class="status-dot"></div>
                    <span data-i18n="ready_to_connect">Ready to connect</span>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn primary" id="connectBtn" data-i18n="connect">Connect</button>
                <button class="btn danger" id="disconnectBtn" data-i18n="disconnect" disabled>Disconnect</button>
                
                <div style="width: 1px; height: 20px; background: var(--border); margin: 0 8px;"></div>
                
                <button class="btn btn-icon" id="helpBtn" title="Help">?</button>
                <button class="btn btn-icon" id="themeToggle" title="Toggle theme">◐</button>
                
                <select id="languageSelect">
                    <option value="en">🇬🇧 English</option>
                    <option value="fr">🇫🇷 Français</option>
                    <option value="it">🇮🇹 Italiano</option>
                    <option value="es">🇪🇸 Español</option>
                    <option value="de">🇩🇪 Deutsch</option>
                </select>
            </div>
        </header>
        
        <!-- Main -->
        <main class="main">
            <div class="display-container">
                <canvas id="display" width="635" height="320"></canvas>
            </div>
        </main>
    </div>
    
    <!-- Notifications -->
    <div class="notifications" id="notifications"></div>
    
    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="help_title">Keyboard Controls</h2>
                <button class="modal-close" id="closeModal">×</button>
            </div>
            <div class="modal-body">
                <div class="section">
                    <div class="section-title" data-i18n="display_controls">Display Controls</div>
                    <div class="shortcuts">
                        <div class="shortcut">
                            <span class="shortcut-key">SPACE</span>
                            <span class="shortcut-desc" data-i18n="screenshot_desc">Take a screenshot</span>
                        </div>
                        <div class="shortcut">
                            <span class="shortcut-key">P</span>
                            <span class="shortcut-desc" data-i18n="lcd_desc">Toggle LCD effect</span>
                        </div>
                        <div class="shortcut">
                            <span class="shortcut-key">I</span>
                            <span class="shortcut-desc" data-i18n="invert_desc">Invert colors</span>
                        </div>
                        <div class="shortcut">
                            <span class="shortcut-key">↑ ↓</span>
                            <span class="shortcut-desc" data-i18n="pixel_size_desc">Adjust pixel size</span>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title" data-i18n="color_controls">Color Schemes</div>
                    <div class="shortcuts">
                        <div class="shortcut">
                            <span class="shortcut-key">G</span>
                            <span class="shortcut-desc" data-i18n="grey_scheme">Grey scheme</span>
                        </div>
                        <div class="shortcut">
                            <span class="shortcut-key">O</span>
                            <span class="shortcut-desc" data-i18n="orange_scheme">Orange scheme</span>
                        </div>
                        <div class="shortcut">
                            <span class="shortcut-key">B</span>
                            <span class="shortcut-desc" data-i18n="blue_scheme">Blue scheme</span>
                        </div>
                        <div class="shortcut">
                            <span class="shortcut-key">W</span>
                            <span class="shortcut-desc" data-i18n="white_scheme">White scheme</span>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title" data-i18n="other_controls">Other</div>
                    <div class="shortcuts">
                        <div class="shortcut">
                            <span class="shortcut-key">Q</span>
                            <span class="shortcut-desc" data-i18n="quit_desc">Disconnect</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
        // Translations dictionary - extended with new keys
        const TRANSLATIONS = {
            en: {
                ready_to_connect: "Ready to connect",
                connected_waiting: "Connected - Waiting for data",
                connected_fps: "Connected - FPS: {fps}",
                connected_no_data: "Connected - No data",
                disconnected: "Disconnected",
                connect: "Connect",
                disconnect: "Disconnect",
                help_title: "Keyboard Controls",
                display_controls: "Display Controls",
                color_controls: "Color Schemes", 
                other_controls: "Other",
                screenshot_desc: "Take a screenshot and download it",
                lcd_desc: "Toggle LCD pixel effect for realistic display",
                invert_desc: "Invert foreground and background colors",
                pixel_size_desc: "Increase/decrease pixel size (3-12)",
                grey_scheme: "Switch to grey color scheme",
                orange_scheme: "Switch to orange color scheme",
                blue_scheme: "Switch to blue color scheme",
                white_scheme: "Switch to white color scheme",
                quit_desc: "Disconnect from the device",
                serial_established: "Serial connection established",
                disconnected_success: "Successfully disconnected",
                screenshot_saved: "Screenshot saved: {filename}",
                pixel_size: "Pixel size: {size}",
                lcd_effect: "LCD effect: {status}",
                lcd_on: "On",
                lcd_off: "Off",
                colors_inverted: "Colors inverted",
                color_changed: "Color: {color}",
                connection_error: "Connection error: {error}",
                disconnection_error: "Disconnection error: {error}",
                serial_read_error: "Serial read error",
                web_serial_not_supported: "Web Serial API not supported. Use Chrome 89+ or Edge 89+",
                app_loaded: "Application loaded. Click \"Connect\" to start."
            },
            fr: {
                ready_to_connect: "Prêt à se connecter",
                connected_waiting: "Connecté - En attente de données",
                connected_fps: "Connecté - FPS: {fps}",
                connected_no_data: "Connecté - Pas de données",
                disconnected: "Déconnecté",
                connect: "Connecter",
                disconnect: "Déconnecter",
                help_title: "Contrôles Clavier",
                display_controls: "Contrôles d'Affichage",
                color_controls: "Schémas de Couleurs",
                other_controls: "Autres",
                screenshot_desc: "Prendre une capture d'écran et la télécharger",
                lcd_desc: "Activer/désactiver l'effet LCD pour un affichage réaliste",
                invert_desc: "Inverser les couleurs de premier plan et d'arrière-plan",
                pixel_size_desc: "Augmenter/diminuer la taille des pixels (3-12)",
                grey_scheme: "Passer au schéma de couleurs gris",
                orange_scheme: "Passer au schéma de couleurs orange",
                blue_scheme: "Passer au schéma de couleurs bleu",
                white_scheme: "Passer au schéma de couleurs blanc",
                quit_desc: "Se déconnecter de l'appareil",
                serial_established: "Connexion série établie",
                disconnected_success: "Déconnexion réussie",
                screenshot_saved: "Capture sauvée : {filename}",
                pixel_size: "Taille pixels : {size}",
                lcd_effect: "Effet LCD : {status}",
                lcd_on: "Activé",
                lcd_off: "Désactivé",
                colors_inverted: "Couleurs inversées",
                color_changed: "Couleur : {color}",
                connection_error: "Erreur de connexion : {error}",
                disconnection_error: "Erreur de déconnexion : {error}",
                serial_read_error: "Erreur de lecture série",
                web_serial_not_supported: "Web Serial API non supportée. Utilisez Chrome 89+ ou Edge 89+",
                app_loaded: "Application chargée. Cliquez \"Connecter\" pour commencer."
            },
            it: {
                ready_to_connect: "Pronto per connettersi",
                connected_waiting: "Connesso - In attesa di dati",
                connected_fps: "Connesso - FPS: {fps}",
                connected_no_data: "Connesso - Nessun dato",
                disconnected: "Disconnesso",
                connect: "Connetti",
                disconnect: "Disconnetti",
                help_title: "Controlli Tastiera",
                display_controls: "Controlli Display",
                color_controls: "Schemi Colore",
                other_controls: "Altri",
                screenshot_desc: "Cattura schermata e scaricala",
                lcd_desc: "Attiva/disattiva effetto LCD per display realistico",
                invert_desc: "Inverti colori primo piano e sfondo",
                pixel_size_desc: "Aumenta/diminuisci dimensione pixel (3-12)",
                grey_scheme: "Passa allo schema colori grigio",
                orange_scheme: "Passa allo schema colori arancione",
                blue_scheme: "Passa allo schema colori blu",
                white_scheme: "Passa allo schema colori bianco",
                quit_desc: "Disconnetti dal dispositivo",
                serial_established: "Connessione seriale stabilita",
                disconnected_success: "Disconnesso con successo",
                screenshot_saved: "Screenshot salvato: {filename}",
                pixel_size: "Dimensione pixel: {size}",
                lcd_effect: "Effetto LCD: {status}",
                lcd_on: "Attivo",
                lcd_off: "Disattivo",
                colors_inverted: "Colori invertiti",
                color_changed: "Colore: {color}",
                connection_error: "Errore di connessione: {error}",
                disconnection_error: "Errore di disconnessione: {error}",
                serial_read_error: "Errore di lettura seriale",
                web_serial_not_supported: "Web Serial API non supportata. Usa Chrome 89+ o Edge 89+",
                app_loaded: "Applicazione caricata. Clicca \"Connetti\" per iniziare."
            },
            es: {
                ready_to_connect: "Listo para conectar",
                connected_waiting: "Conectado - Esperando datos",
                connected_fps: "Conectado - FPS: {fps}",
                connected_no_data: "Conectado - Sin datos",
                disconnected: "Desconectado",
                connect: "Conectar",
                disconnect: "Desconectar",
                help_title: "Controles del Teclado",
                display_controls: "Controles de Pantalla",
                color_controls: "Esquemas de Color",
                other_controls: "Otros",
                screenshot_desc: "Tomar captura de pantalla y descargarla",
                lcd_desc: "Activar/desactivar efecto LCD para pantalla realista",
                invert_desc: "Invertir colores de primer plano y fondo",
                pixel_size_desc: "Aumentar/disminuir tamaño de píxel (3-12)",
                grey_scheme: "Cambiar a esquema de color gris",
                orange_scheme: "Cambiar a esquema de color naranja",
                blue_scheme: "Cambiar a esquema de color azul",
                white_scheme: "Cambiar a esquema de color blanco",
                quit_desc: "Desconectar del dispositivo",
                serial_established: "Conexión serie establecida",
                disconnected_success: "Desconectado exitosamente",
                screenshot_saved: "Captura guardada: {filename}",
                pixel_size: "Tamaño píxel: {size}",
                lcd_effect: "Efecto LCD: {status}",
                lcd_on: "Activado",
                lcd_off: "Desactivado",
                colors_inverted: "Colores invertidos",
                color_changed: "Color: {color}",
                connection_error: "Error de conexión: {error}",
                disconnection_error: "Error de desconexión: {error}",
                serial_read_error: "Error de lectura serie",
                web_serial_not_supported: "Web Serial API no soportada. Usa Chrome 89+ o Edge 89+",
                app_loaded: "Aplicación cargada. Haz clic en \"Conectar\" para empezar."
            },
            de: {
                ready_to_connect: "Bereit zum Verbinden",
                connected_waiting: "Verbunden - Warte auf Daten",
                connected_fps: "Verbunden - FPS: {fps}",
                connected_no_data: "Verbunden - Keine Daten",
                disconnected: "Getrennt",
                connect: "Verbinden",
                disconnect: "Trennen",
                help_title: "Tastatursteuerung",
                display_controls: "Anzeigesteuerung",
                color_controls: "Farbschemata",
                other_controls: "Sonstiges",
                screenshot_desc: "Screenshot erstellen und herunterladen",
                lcd_desc: "LCD-Pixeleffekt für realistische Anzeige umschalten",
                invert_desc: "Vordergrund- und Hintergrundfarben invertieren",
                pixel_size_desc: "Pixelgröße erhöhen/verringern (3-12)",
                grey_scheme: "Zu grauem Farbschema wechseln",
                orange_scheme: "Zu orangem Farbschema wechseln",
                blue_scheme: "Zu blauem Farbschema wechseln",
                white_scheme: "Zu weißem Farbschema wechseln",
                quit_desc: "Vom Gerät trennen",
                serial_established: "Serielle Verbindung hergestellt",
                disconnected_success: "Erfolgreich getrennt",
                screenshot_saved: "Screenshot gespeichert: {filename}",
                pixel_size: "Pixelgröße: {size}",
                lcd_effect: "LCD-Effekt: {status}",
                lcd_on: "Ein",
                lcd_off: "Aus",
                colors_inverted: "Farben umgekehrt",
                color_changed: "Farbe: {color}",
                connection_error: "Verbindungsfehler: {error}",
                disconnection_error: "Trennungsfehler: {error}",
                serial_read_error: "Serieller Lesefehler",
                web_serial_not_supported: "Web Serial API nicht unterstützt. Verwende Chrome 89+ oder Edge 89+",
                app_loaded: "Anwendung geladen. Klicke \"Verbinden\" zum Starten."
            }
        };
        
        // Constants - same as Python version
        const VERSION = '2.0';
        const BAUDRATE = 38400;
        const WIDTH = 128;
        const HEIGHT = 64;
        const FRAME_SIZE = 1024;
        
        // Protocol
        const HEADER = new Uint8Array([0xAA, 0x55]);
        const TYPE_SCREENSHOT = 0x01;
        const TYPE_DIFF = 0x02;
        
        // Color sets - same as Python version
        const COLOR_SETS = {
            'g': ['Grey', '#000000', '#CACACA'],
            'o': ['Orange', '#000000', '#FFC125'], 
            'b': ['Blue', '#000000', '#1C86E4'],
            'w': ['White', '#000000', '#FFFFFF']
        };
        
        let DEFAULT_COLOR = 'g';
        
        // State variables
        let framebuffer = new Uint8Array(FRAME_SIZE);
        let port = null;
        let reader = null;
        let writer = null;
        let isConnected = false;
        let pixelSize = 5;
        let pixelLcd = 0;
        let currentColorKey = DEFAULT_COLOR;
        let frameCount = 0;
        let frameLost = 0;
        let lastTime = performance.now();
        let keepaliveInterval = null;
        let currentLanguage = 'en';
        let isDarkTheme = false;
        
        // DOM elements
        const canvas = document.getElementById('display');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const notifications = document.getElementById('notifications');
        const languageSelect = document.getElementById('languageSelect');
        const themeToggle = document.getElementById('themeToggle');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeModal = document.getElementById('closeModal');
        
        // Initialize canvas
        updateCanvasSize();
        
        // Translation functions
        function t(key, params = {}) {
            let text = TRANSLATIONS[currentLanguage][key] || TRANSLATIONS['en'][key] || key;
            
            // Replace parameters in text
            Object.keys(params).forEach(param => {
                text = text.replace(`{${param}}`, params[param]);
            });
            
            return text;
        }
        
        function updateUI() {
            // Update all translatable elements
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
            
            // Update status
            if (!isConnected) {
                updateStatus(t('ready_to_connect'));
            }
        }
        
        function changeLanguage(lang) {
            if (lang in TRANSLATIONS) {
                currentLanguage = lang;
                document.documentElement.lang = lang;
                updateUI();
                console.log(`Language changed to: ${lang}`);
            }
        }
        
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.setAttribute('data-theme', isDarkTheme ? 'dark' : 'light');
            themeToggle.textContent = isDarkTheme ? '◑' : '◐';
        }
        
        function updateCanvasSize() {
            canvas.width = WIDTH * (pixelSize - 1);
            canvas.height = HEIGHT * pixelSize;
            drawFrame();
        }
        
        function showNotification(key, params = {}, type = 'info') {
            const div = document.createElement('div');
            div.className = `notification ${type}`;
            div.textContent = t(key, params);
            
            // Add to notifications container
            notifications.appendChild(div);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (div.parentNode) {
                    div.style.animation = 'slideOut 0.3s ease forwards';
                    setTimeout(() => div.remove(), 300);
                }
            }, 4000);
            
            // Keep only last 5 notifications
            const notificationElements = notifications.querySelectorAll('.notification');
            if (notificationElements.length > 5) {
                notificationElements[0].remove();
            }
        }
        
        function updateStatus(text) {
            const statusSpan = status.querySelector('span');
            statusSpan.textContent = text;
            
            if (isConnected) {
                status.classList.add('connected');
            } else {
                status.classList.remove('connected');
            }
        }
        
        function showModal() {
            helpModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        function hideModal() {
            helpModal.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        async function connectSerial() {
            try {
                if (!('serial' in navigator)) {
                    throw new Error(t('web_serial_not_supported'));
                }
                
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: BAUDRATE });
                
                reader = port.readable.getReader();
                writer = port.writable.getWriter();
                
                isConnected = true;
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                updateStatus(t('connected_waiting'));
                showNotification('serial_established', {}, 'success');
                
                // Start keepalive
                keepaliveInterval = setInterval(sendKeepalive, 1000);
                
                // Start reading frames
                readFrames();
                
            } catch (error) {
                showNotification('connection_error', { error: error.message }, 'error');
                console.error('Connection error:', error);
            }
        }
        
        async function disconnectSerial() {
            try {
                isConnected = false;
                
                if (keepaliveInterval) {
                    clearInterval(keepaliveInterval);
                    keepaliveInterval = null;
                }
                
                if (reader) {
                    await reader.cancel();
                    reader.releaseLock();
                    reader = null;
                }
                
                if (writer) {
                    await writer.close();
                    writer = null;
                }
                
                if (port) {
                    await port.close();
                    port = null;
                }
                
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                
                updateStatus(t('disconnected'));
                showNotification('disconnected_success', {}, 'success');
                
            } catch (error) {
                showNotification('disconnection_error', { error: error.message }, 'error');
                console.error('Disconnection error:', error);
            }
        }
        
        async function sendKeepalive() {
            if (!writer || !isConnected) return;
            
            try {
                const keepalive = new Uint8Array([0x55, 0xAA, 0x00, 0x00]);
                await writer.write(keepalive);
            } catch (error) {
                console.error('Keepalive error:', error);
            }
        }
        
        async function readFrames() {
            const buffer = new Uint8Array(4096);
            let bufferPos = 0;
            
            while (isConnected && reader) {
                try {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    // Add new data to buffer
                    if (bufferPos + value.length > buffer.length) {
                        buffer.copyWithin(0, bufferPos);
                        bufferPos = 0;
                    }
                    buffer.set(value, bufferPos);
                    bufferPos += value.length;
                    
                    // Process frames in buffer
                    let processed = 0;
                    while (processed < bufferPos - 4) {
                        if (buffer[processed] === HEADER[0] && buffer[processed + 1] === HEADER[1]) {
                            const type = buffer[processed + 2];
                            const size = (buffer[processed + 3] << 8) | buffer[processed + 4];
                            
                            if (processed + 5 + size <= bufferPos) {
                                const payload = buffer.slice(processed + 5, processed + 5 + size);
                                
                                if (type === TYPE_SCREENSHOT && size === FRAME_SIZE) {
                                    framebuffer = new Uint8Array(payload);
                                    drawFrame();
                                    updateFPS();
                                } else if (type === TYPE_DIFF && size % 9 === 0) {
                                    applyDiff(payload);
                                    drawFrame();
                                    updateFPS();
                                }
                                
                                processed += 5 + size;
                            } else {
                                break; // Not enough data for complete frame
                            }
                        } else {
                            processed++;
                        }
                    }
                    
                    // Remove processed data from buffer
                    if (processed > 0) {
                        buffer.copyWithin(0, processed);
                        bufferPos -= processed;
                    }
                    
                } catch (error) {
                    if (isConnected) {
                        console.error('Read error:', error);
                        showNotification('serial_read_error', {}, 'error');
                        await disconnectSerial();
                    }
                    break;
                }
            }
        }
        
        function applyDiff(diffPayload) {
            let i = 0;
            while (i + 9 <= diffPayload.length) {
                const blockIndex = diffPayload[i];
                i++;
                if (blockIndex >= 128) break;
                
                const startPos = blockIndex * 8;
                for (let j = 0; j < 8; j++) {
                    if (startPos + j < framebuffer.length) {
                        framebuffer[startPos + j] = diffPayload[i + j];
                    }
                }
                i += 8;
            }
        }
        
        function getBit(bitIdx) {
            const byteIdx = Math.floor(bitIdx / 8);
            const bitPos = bitIdx % 8;
            if (byteIdx < framebuffer.length) {
                return (framebuffer[byteIdx] >> bitPos) & 0x01;
            }
            return 0;
        }
        
        function drawFrame() {
            const [, fgColor, bgColor] = COLOR_SETS[currentColorKey];
            
            // Clear canvas with background color
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw pixels
            ctx.fillStyle = fgColor;
            let bitIndex = 0;
            
            for (let y = 0; y < HEIGHT; y++) {
                for (let x = 0; x < WIDTH; x++) {
                    if (getBit(bitIndex)) {
                        const px = x * (pixelSize - 1);
                        const py = y * pixelSize;
                        const width = pixelSize - 1 - pixelLcd;
                        const height = pixelSize - pixelLcd;
                        ctx.fillRect(px, py, width, height);
                    }
                    bitIndex++;
                }
            }
        }
        
        function updateFPS() {
            frameCount++;
            const now = performance.now();
            
            if (now - lastTime >= 1000) {
                const fps = frameCount / ((now - lastTime) / 1000);
                updateStatus(t('connected_fps', { fps: fps.toFixed(1) }));
                frameCount = 0;
                lastTime = now;
                frameLost = 0;
            }
        }
        
        function handleNoData() {
            frameLost = Math.min(frameLost + 1, 5);
            if (frameLost === 5) {
                updateStatus(t('connected_no_data'));
            }
        }
        
        function saveScreenshot() {
            const link = document.createElement('a');
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').split('T');
            const filename = `screenshot_${timestamp[0]}_${timestamp[1].split('.')[0]}.png`;
            
            link.download = filename;
            link.href = canvas.toDataURL();
            link.click();
            
            showNotification('screenshot_saved', { filename }, 'success');
        }
        
        function toggleColors() {
            // Invert colors like in Python version
            const [, fgColor, bgColor] = COLOR_SETS[currentColorKey];
            if (bgColor === '#000000') {
                COLOR_SETS[currentColorKey][2] = fgColor;
                COLOR_SETS[currentColorKey][1] = '#000000';
            } else {
                COLOR_SETS[currentColorKey][1] = bgColor;
                COLOR_SETS[currentColorKey][2] = '#000000';
            }
            drawFrame();
            showNotification('colors_inverted', {}, 'info');
        }
        
        function changePixelSize(delta) {
            const newSize = pixelSize + delta;
            if (newSize >= 3 && newSize <= 12) {
                pixelSize = newSize;
                updateCanvasSize();
                showNotification('pixel_size', { size: pixelSize }, 'info');
            }
        }
        
        function changeColorSet(key) {
            if (key in COLOR_SETS) {
                currentColorKey = key;
                const [name] = COLOR_SETS[key];
                showNotification('color_changed', { color: name }, 'info');
                drawFrame();
            }
        }
        
        // Event listeners
        connectBtn.addEventListener('click', connectSerial);
        disconnectBtn.addEventListener('click', disconnectSerial);
        themeToggle.addEventListener('click', toggleTheme);
        helpBtn.addEventListener('click', showModal);
        closeModal.addEventListener('click', hideModal);
        
        // Close modal when clicking outside
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                hideModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && helpModal.classList.contains('show')) {
                hideModal();
                return;
            }
        });
        
        languageSelect.addEventListener('change', (event) => {
            changeLanguage(event.target.value);
        });
        
        // Keyboard controls - same as Python version
        document.addEventListener('keydown', (event) => {
            // Don't process keyboard shortcuts when modal is open
            if (helpModal.classList.contains('show')) return;
            
            const key = event.key.toLowerCase();
            
            switch (key) {
                case ' ': // Space
                    event.preventDefault();
                    saveScreenshot();
                    break;
                    
                case 'p':
                    pixelLcd = 1 - pixelLcd;
                    drawFrame();
                    const lcdStatus = pixelLcd ? t('lcd_on') : t('lcd_off');
                    showNotification('lcd_effect', { status: lcdStatus }, 'info');
                    break;
                    
                case 'i':
                    toggleColors();
                    break;
                    
                case 'arrowup':
                    event.preventDefault();
                    changePixelSize(1);
                    break;
                    
                case 'arrowdown':
                    event.preventDefault();
                    changePixelSize(-1);
                    break;
                    
                case 'q':
                    if (isConnected) {
                        disconnectSerial();
                    }
                    break;
                    
                case 'g':
                case 'o':
                case 'b':
                case 'w':
                    changeColorSet(key);
                    break;
                    
                case 'h':
                case '?':
                    showModal();
                    break;
            }
        });
        
        // Initialize language detection
        function detectLanguage() {
            const browserLang = navigator.language.substring(0, 2);
            if (browserLang in TRANSLATIONS) {
                currentLanguage = browserLang;
                languageSelect.value = browserLang;
            }
        }
        
        // Check Web Serial API support
        if (!('serial' in navigator)) {
            showNotification('web_serial_not_supported', {}, 'error');
            connectBtn.disabled = true;
        } else {
            // Show initial notification only if Web Serial is supported
            showNotification('app_loaded', {}, 'info');
        }
        
        // Initialize app
        detectLanguage();
        updateUI();
        drawFrame();
        
        console.log('K5Viewer Web v' + VERSION + ' - Ready');
        console.log('Web Serial API supported:', 'serial' in navigator);
    </script>
</body>
</html>
            